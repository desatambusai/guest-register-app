<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Register Tamu</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <img src="logo_tambusai.png" alt="Logo Desa Tambusai" class="header-logo">
        <h1>BUKU REGISTER TAMU</h1>
        <h1>PEMERINTAH DESA TAMBUSAI KEC. RUMBIO JAYA KAB. KAMPAR</h1>
    </header>

    <main>
        <div class="card">
            <h2>Formulir Kunjungan</h2>
            <form id="guestForm">
                <label for="nama">Nama Lengkap *</label>
                <input type="text" id="nama" name="Nama" required>

                <label for="instansi">Asal Instansi *</label>
                <input type="text" id="instansi" name="Asal Instansi" required>

                <label for="hpwa">Nomor HP/WhatsApp *</label>
                <input type="tel" id="hpwa" name="Nomor HP/WA" required pattern="[0-9]{8,15}" title="Masukkan nomor yang valid (8-15 digit)">
                
                <div class="date-time-group">
                <label for="tanggal">Tanggal Kunjungan *</label>
                <input type="date" id="tanggal" name="Tanggal Kunjungan" required>
    
                <label for="waktu">Waktu Kunjungan *</label>
                <input type="time" id="waktu" name="Waktu Kunjungan" required>
                </div>
                <label for="tujuan">Tujuan Kunjungan *</label>
                <textarea id="tujuan" name="Tujuan" required rows="3"></textarea>
                                
                <div class="camera-section">
                    <label>Ambil Foto Selfie *</label>
                    <div class="camera-display">
                        <video id="webcam-preview" autoplay playsinline></video>
                        <canvas id="photo-canvas" style="display:none;"></canvas>
                    </div>
                    <button type="button" id="toggle-camera" class="camera-button">Nyalakan Kamera</button>
                    <button type="button" id="take-photo" class="camera-button" disabled>Ambil Foto</button>
                    <p id="photo-status" class="status-text"></p>
                    <input type="hidden" id="photo-base64" name="Foto Selfie">
                </div>
                
                <button type="submit" class="submit-button" disabled>Kirim Data</button>
            </form>
        </div>
    </main>
    
    <div id="notification" class="notification"></div>

    <script>
        // TANGGAL DAN WAKTU
        document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const dateInput = document.getElementById('tanggal');
        const timeInput = document.getElementById('waktu');
    
    // Format tanggal ke YYYY-MM-DD
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Januari adalah 0!
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    
    // Format waktu ke HH:MM
        const hh = String(today.getHours()).padStart(2, '0');
        const mi = String(today.getMinutes()).padStart(2, '0');
        timeInput.value = `${hh}:${mi}`;
});

        // --- KONFIGURASI ---
        // GANTI DENGAN ENDPOINT GOOGLE APPS SCRIPT ANDA
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwuHmo9Rxr581_12Q-2ylxVRJFrm8jK8U8-AL-mDWoptKY0CIff7iRSyZTfZW0yi_gqXw/exec'; 
        // -------------------

        const form = document.getElementById('guestForm');
        const webcamPreview = document.getElementById('webcam-preview');
        const photoCanvas = document.getElementById('photo-canvas');
        const takePhotoBtn = document.getElementById('take-photo');
        const toggleCameraBtn = document.getElementById('toggle-camera');
        const photoBase64Input = document.getElementById('photo-base64');
        const submitBtn = form.querySelector('.submit-button');
        const photoStatus = document.getElementById('photo-status');
        const notification = document.getElementById('notification');
        
        let stream = null; // Untuk menyimpan stream kamera

        // 1. Logika Kamera
        async function startCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            try {
                // Akses kamera belakang (preferensi 'environment') atau kamera depan
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: 'user' // 'user' untuk kamera depan/selfie
                    }, 
                    audio: false 
                });
                webcamPreview.srcObject = stream;
                webcamPreview.style.display = 'block';
                webcamPreview.play();
                takePhotoBtn.disabled = false;
                toggleCameraBtn.textContent = 'Matikan Kamera';
                photoStatus.textContent = 'Kamera aktif. Silakan berpose.';
            } catch (err) {
                console.error("Gagal mengakses kamera: ", err);
                photoStatus.textContent = `âŒ Gagal mengakses kamera. Pastikan izin diberikan. Error: ${err.name}`;
                takePhotoBtn.disabled = true;
                webcamPreview.style.display = 'none';
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                webcamPreview.srcObject = null;
                webcamPreview.style.display = 'none';
                takePhotoBtn.disabled = true;
                toggleCameraBtn.textContent = 'Nyalakan Kamera';
                photoStatus.textContent = 'Kamera nonaktif.';
            }
        }

        toggleCameraBtn.addEventListener('click', () => {
            if (stream) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        takePhotoBtn.addEventListener('click', () => {
            if (stream) {
                // Set ukuran canvas sesuai video
                photoCanvas.width = webcamPreview.videoWidth;
                photoCanvas.height = webcamPreview.videoHeight;
                
                // Gambar frame video ke canvas
                const context = photoCanvas.getContext('2d');
                context.drawImage(webcamPreview, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Konversi canvas ke Base64 (JPEG)
                const dataURL = photoCanvas.toDataURL('image/jpeg', 0.8); // Kualitas 80%
                photoBase64Input.value = dataURL;
                
                // Tampilkan preview foto di canvas
                webcamPreview.style.display = 'none';
                photoCanvas.style.display = 'block';
                takePhotoBtn.textContent = 'Ulangi Foto';
                photoStatus.textContent = 'âœ… Foto berhasil diambil. Klik "Ulangi Foto" untuk ambil ulang.';

                // Setelah foto diambil, cek validasi form
                checkFormValidity();
            }
        });

        // 2. Logika Validasi Form
        function checkFormValidity() {
            const allRequiredFilled = form.checkValidity();
            const photoTaken = photoBase64Input.value !== '';
            
            submitBtn.disabled = !(allRequiredFilled && photoTaken);
        }

        // Cek validasi saat ada perubahan input
        form.addEventListener('input', checkFormValidity);

        // 3. Logika Submit Form
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'GANTI_DENGAN_URL_DEPLOYMENT_ANDA') {
                alert('ðŸš¨ ERROR: Harap ganti variabel GAS_WEB_APP_URL dengan URL Deployment Google Apps Script Anda.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Mengirim...';
            showNotification('Mengirim data...', 'info');
            
            // Ambil semua data form
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Tambahkan Timestamp di sisi client (walaupun GAS juga akan menambahkan)
            data['TimestampClient'] = new Date().toISOString();

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Penting untuk GAS doPost
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    // Kirim data sebagai string URL-encoded
                    body: new URLSearchParams(data).toString()
                });

                // Karena mode: 'no-cors' kita tidak bisa cek response.ok, 
                // tapi jika tidak ada error di fetch, kita asumsikan sukses.
                
                // Sukses
                showNotification('âœ… Data Berhasil Disimpan! Terima kasih atas kunjungan Anda.', 'success');
                form.reset();
                photoBase64Input.value = ''; // Reset Base64 input
                stopCamera();
                webcamPreview.style.display = 'none';
                photoCanvas.style.display = 'none'; // Sembunyikan canvas
                takePhotoBtn.textContent = 'Ambil Foto';
                submitBtn.textContent = 'Kirim Data';
                submitBtn.disabled = true;

            } catch (error) {
                console.error('Error saat menyimpan data:', error);
                showNotification('âŒ Gagal Menyimpan Data. Periksa koneksi atau URL API.', 'error');
                submitBtn.textContent = 'Kirim Data';
                submitBtn.disabled = false;
            }
        });

        // 4. Logika Notifikasi
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Hilangkan notifikasi setelah 5 detik (kecuali error)
            if (type !== 'error') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }

        // Inisialisasi: Matikan kamera saat pertama kali dimuat
        stopCamera();
    </script>
</body>
</html>